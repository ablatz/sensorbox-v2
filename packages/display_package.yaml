# ============================
# Display Package for SensorBox
# ============================

# ----------------------------
# BRIGHTNESS CONTROL
# ----------------------------
number:
  - platform: template
    id: display_brightness
    name: "Display Brightness"
    min_value: 0
    max_value: 100
    step: 1
    initial_value: 33  # ← CHANGED FROM 50 TO 33
    restore_value: yes
    optimistic: true
    on_value:
      then:
        - light.turn_on:
            id: back_light
            brightness: !lambda 'return x / 100.0;'

# Set brightness immediately on boot to prevent scan lines
esphome:
  on_boot:
    priority: 600
    then:
      - delay: 100ms  # Short delay to ensure PWM is ready
      - light.turn_on:
          id: back_light
          brightness: !lambda 'return id(display_brightness).state / 100.0;'

# ----------------------------
# FONTS
# ----------------------------
font:
  - file: "gfonts://Rubik@300"
    id: font_label_14
    size: 14
    bpp: 4
    glyphs: [
      "0","1","2","3","4","5","6","7","8","9","µ","³","/","°","%","(",")","-", "_",":","."," ",A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z
    ]
  - file: "gfonts://Rubik@300"
    id: font_label_18
    size: 18
    bpp: 4
    glyphs: [
      "0","1","2","3","4","5","6","7","8","9","µ","³","/","°","%","(",")","-", "_",":","."," ",A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z
    ]
  - file: "gfonts://Rubik@400"
    id: font_value_30
    size: 30
    bpp: 4
    glyphs: [
      "0","1","2","3","4","5","6","7","8","9",".","-"
    ]
  - file: "gfonts://Orbitron"
    id: font_heading_36
    size: 36
    bpp: 4
    glyphs: ["2",A,C,F,I,O,P,V,W,a,c,e,i,l,r,s,t," ", "."]  # Added dot
  - file: "gfonts://Rubik@300"
    id: font_label_25
    size: 25
    bpp: 4
    glyphs: [
      "0","1","2","3","4","5","6","7","8","9","µ","³","/","°","%","(",")","-", "_",":","."," ",A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z
    ]

# ----------------------------
# COLORS
# ----------------------------
color:
  - id: white
    hex: "FFFFFF"
  - id: grey
    hex: "AAAAAA"
  - id: light_grey
    hex: "CCCCCC"
  - id: yellow
    hex: "FFFA72"
  - id: orange
    hex: "FF9C32"
  - id: red
    hex: "FF1616"
  - id: purple
    hex: "FF16E0"
  - id: blue
    hex: "0000FF"
  - id: green
    hex: "00FF00"
  - id: cyan
    hex: "00FFFF"
  - id: magenta
    hex: "FF00FF"
  - id: dim_green
    hex: "007700"
  - id: dim_red
    hex: "770000"
  - id: black
    hex: "000000"


# ----------------------------
# GRAPHS
# ----------------------------
graph:
  # 1h Graphs - Reduced grid density for small graphs
  - id: temperature_graph
    duration: 1h
    x_grid: 20min
    width: 151
    height: 51
    min_value: 15
    max_value: 30
    traces:
      - sensor: temperature
        line_type: SOLID
        color: blue

  - id: humidity_graph
    duration: 1h
    x_grid: 20min
    width: 151
    height: 51
    min_value: 1
    max_value: 100
    traces:
      - sensor: humidity
        line_type: SOLID
        color: green

  - id: pressure_graph
    duration: 1h
    x_grid: 20min
    width: 151
    height: 51
    min_value: 950
    max_value: 1050
    traces:
      - sensor: pres_bmp280
        line_type: SOLID
        color: magenta

  - id: co2_graph
    duration: 1h
    x_grid: 20min
    width: 151
    height: 51
    min_value: 1
    max_value: 3000
    traces:
      - sensor: co2_scd40
        line_type: SOLID
        color: cyan

  - id: voc_graph
    duration: 1h
    x_grid: 20min
    width: 151
    height: 51
    min_value: 1
    max_value: 3000
    traces:
      - sensor: tvoc_sgp30
        line_type: SOLID
        color: orange

  - id: particles_graph
    duration: 1h
    x_grid: 20min
    width: 151
    height: 51
    min_value: 0
    max_value: 50
    traces:
      - sensor: pm1_pms
        line_type: SOLID
        color: red
      - sensor: pm25_pms
        line_type: SOLID
        color: orange
      - sensor: pm10_pms
        line_type: SOLID
        color: yellow

  # 24h Graphs - Reduced grid density
  - id: temperature_graph_24h
    duration: 24h
    x_grid: 6h
    width: 151
    height: 51
    min_value: 15
    max_value: 30
    traces:
      - sensor: temperature
        line_type: SOLID
        color: blue

  - id: humidity_graph_24h
    duration: 24h
    x_grid: 6h
    width: 151
    height: 51
    min_value: 1
    max_value: 100
    traces:
      - sensor: humidity
        line_type: SOLID
        color: green

  - id: pressure_graph_24h
    duration: 24h
    x_grid: 6h
    width: 151
    height: 51
    min_value: 950
    max_value: 1050
    traces:
      - sensor: pres_bmp280
        line_type: SOLID
        color: magenta

  - id: co2_graph_24h
    duration: 24h
    x_grid: 6h
    width: 151
    height: 51
    min_value: 1
    max_value: 3000
    traces:
      - sensor: co2_scd40
        line_type: SOLID
        color: cyan

  - id: voc_graph_24h
    duration: 24h
    x_grid: 6h
    width: 151
    height: 51
    min_value: 1
    max_value: 3000
    traces:
      - sensor: tvoc_sgp30
        line_type: SOLID
        color: orange

  - id: particles_graph_24h
    duration: 24h
    x_grid: 6h
    width: 151
    height: 51
    min_value: 0
    max_value: 50
    traces:
      - sensor: pm1_pms
        line_type: SOLID
        color: red
      - sensor: pm25_pms
        line_type: SOLID
        color: orange
      - sensor: pm10_pms
        line_type: SOLID
        color: yellow

# ----------------------------
# PSRAM
# ----------------------------
psram:
  mode: quad
  speed: 80MHz

# ----------------------------
# BACKLIGHT
# ----------------------------
output:
  - platform: ledc
    pin: GPIO15
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: back_light
    restore_mode: ALWAYS_ON
    default_transition_length: 0s

display:
  - platform: ili9xxx    
    model: ILI9341
    cs_pin: GPIO03
    dc_pin: GPIO04
    reset_pin: GPIO06
    transform:
      mirror_x: ${display_mirror_x}
      mirror_y: ${display_mirror_y}
      swap_xy: ${display_swap_xy}
    color_order: ${display_color_order}
    invert_colors: false
    color_palette: 8BIT
    lambda: |-
      it.fill(Color::BLACK);

      auto fv30 = id(font_value_30);
      auto fh36 = id(font_heading_36);
      auto fl14 = id(font_label_14);
      auto fl18 = id(font_label_18);
      auto fl25 = id(font_label_25);

      auto w = it.get_width();
      auto h = it.get_height();

      // --- WIFI STATUS INDICATOR (ONLY ON PAGE 0) ---
      if (id(page_number) == 0) {
        bool wifi_connected = false;
        #ifdef USE_WIFI
        wifi_connected = (WiFi.status() == WL_CONNECTED);
        #endif
        
        int wifi_circle_x = 6;
        int wifi_circle_y = 16;
        int wifi_circle_radius = 3;
        
        auto wifi_color = wifi_connected ? id(dim_green) : id(dim_red);
        it.filled_circle(wifi_circle_x, wifi_circle_y, wifi_circle_radius, wifi_color);
      }

      // --- CLOCK DISPLAY (ONLY ON PAGE 0 WITH WIFI) ---
      if (id(page_number) == 0) {
        #ifdef USE_WIFI
        if (WiFi.status() == WL_CONNECTED && id(esptime).now().is_valid()) {
        #else
        if (id(esptime).now().is_valid()) {
        #endif
            auto time = id(esptime).now();
            char time_buf[6];  
            char date_buf[11]; 
            sprintf(time_buf, "%02d:%02d", time.hour, time.minute);
            sprintf(date_buf, "%02d/%02d/%04d", time.day_of_month, time.month, time.year);
            
            it.print(w - 5, h - 25, fl25, id(white), TextAlign::BOTTOM_RIGHT, time_buf);
            it.print(w - 5, h - 5, fl18, id(grey), TextAlign::BOTTOM_RIGHT, date_buf);
        }
      }


      float pressure = id(pres_bmp280).state;

      if (isnan(pressure)) {
        pressure = 0;
      }
    
      if (id(page_number) == 1) {

        it.printf(w - 10, 0, fl14, id(white),  TextAlign::TOP_RIGHT, "LAST HOUR"     );

        auto pos = 20;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "°C  30"       );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "TEMP"     );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "15"   );
        it.graph (80, pos     , id(temperature_graph));

        pos += 60;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "%cRH  100", '%');
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "HUM"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"   );
        it.graph (80, pos     , id(humidity_graph));

        pos += 60;
        // REPLACED PRESSURE WITH PARTICLES GRAPH
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "µg/m³  50"      );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "PTCL"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"   );
        it.graph (80, pos     , id(particles_graph));

        pos += 60;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "ppm  3000"      );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "CO2"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"  );
        it.graph (80, pos     , id(co2_graph));

        pos += 60;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "ppb  1000"      );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "VOC"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"  );
        it.graph (80, pos     , id(voc_graph));

      } else if (id(page_number) == 2) {

        it.printf(w - 10, 0, fl14, id(white),  TextAlign::TOP_RIGHT, "LAST 24 HOURS" );

        auto pos = 20;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "°C  30"       );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "TEMP"     );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "15"   );
        it.graph (80, pos     , id(temperature_graph_24h));

        pos += 60;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "%cRH  100", '%');
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "HUM"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"   );
        it.graph (80, pos     , id(humidity_graph_24h));

        pos += 60;
        // REPLACED PRESSURE WITH PARTICLES GRAPH
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "µg/m³  50"      );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "PTCL"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"   );
        it.graph (80, pos     , id(particles_graph_24h));

        pos += 60;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "ppm  3000"      );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "CO2"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"  );
        it.graph (80, pos     , id(co2_graph_24h));

        pos += 60;
        it.printf(75, pos + 15, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "ppb  1000"      );
        it.printf(75, pos + 37, fl18, id(white), TextAlign::BOTTOM_RIGHT, "VOC"      );
        it.printf(75, pos + 53, fl14, id(grey),  TextAlign::BOTTOM_RIGHT, "0"  );
        it.graph (80, pos     , id(voc_graph_24h));

      } else {
        
        // PAGE 0 - Complete sensor display
        auto cy = 0; // current Y position
        auto ix = 0; // current X grid position

        // GET SENSOR STATES
        auto col     = id(white);
        
        auto co2     = id(co2_scd40).state;
        auto e_co2   = id(eco2_ens160).state;
        auto s_co2   = id(eco2_sgp30).state;
        auto ch2o    = id(ch2o_ze08).state;
        auto e_voc   = id(tvoc_ens160).state;
        auto s_voc   = id(tvoc_sgp30).state;
        auto pm1     = id(pm1_pms).state;
        auto pm25    = id(pm25_pms).state;
        auto pm10    = id(pm10_pms).state;
        auto aqi_voc = id(aqi_voc_sgp41).state;
        auto aqi_nox = id(aqi_nox_sgp41).state;

        // SET COLOR FOR EACH READING
        
        col = id(white);
        if (co2 >  800) { col = id(yellow); }
        if (co2 > 1200) { col = id(orange); }
        if (co2 > 1500) { col = id(red);    }
        if (co2 > 1800) { col = id(purple); }
        auto co2_c = col;

        col = id(white);
        if (e_co2 >  800) { col = id(yellow); }
        if (e_co2 > 1200) { col = id(orange); }
        if (e_co2 > 1500) { col = id(red);    }
        if (e_co2 > 1800) { col = id(purple); }
        auto e_co2_c = col;

        col = id(white);
        if (s_co2 >  800) { col = id(yellow); }
        if (s_co2 > 1200) { col = id(orange); }
        if (s_co2 > 1500) { col = id(red);    }
        if (s_co2 > 1800) { col = id(purple); }
        auto s_co2_c = col;

        col = id(white);
        if (ch2o >  60) { col = id(yellow); }
        if (ch2o > 100) { col = id(orange); }
        if (ch2o > 150) { col = id(red);    }
        if (ch2o > 200) { col = id(purple); }
        auto ch2o_c = col;

        col = id(white);
        if (e_voc >  400) {col = id(yellow); }
        if (e_voc >  800) {col = id(orange); }
        if (e_voc > 1400) {col = id(red);    }
        if (e_voc > 2000) {col = id(purple); }
        auto e_voc_c = col;

        col = id(white);
        if (s_voc >  300) {col = id(yellow); }
        if (s_voc >  600) {col = id(orange); }
        if (s_voc > 1000) {col = id(red);    }
        if (s_voc > 1500) {col = id(purple); }
        auto s_voc_c = col;

        col = id(white);
        if (pm1 >  5) {col = id(yellow); }
        if (pm1 > 10) {col = id(orange); }
        if (pm1 > 15) {col = id(red);    }
        if (pm1 > 25) {col = id(purple); }
        auto pm1_c = col;

        col = id(white);
        if (pm25 >  5) {col = id(yellow); }
        if (pm25 > 10) {col = id(orange); }
        if (pm25 > 15) {col = id(red);    }
        if (pm25 > 25) {col = id(purple); }
        auto pm25_c = col;

        col = id(white);
        if (pm10 > 15) {col = id(yellow); }
        if (pm10 > 45) {col = id(orange); }
        if (pm10 > 60) {col = id(red);    }
        if (pm10 > 80) {col = id(purple); }
        auto pm10_c = col;

        // DRAW TEMPERATURE HUMIDITY and PRESSURE
        it.printf( 75, 18, fl14, id(grey), TextAlign::BOTTOM_LEFT,  "°C"            );
        it.printf( 75, 34, fv30, id(white),    TextAlign::BOTTOM_RIGHT, "%.1f", id(temperature).state    );

        it.printf(125, 18, fl14, id(grey), TextAlign::BOTTOM_LEFT,  "RH"            );
        it.printf(125, 30, fl14, id(grey), TextAlign::BOTTOM_LEFT,  "%c", '%'       );
        it.printf(125, 34, fv30, id(white),    TextAlign::BOTTOM_RIGHT, "%.0f", id(humidity).state     );

        it.printf(215, 18, fl14, id(grey), TextAlign::BOTTOM_LEFT,  "hPa"           );
        it.printf(215, 34, fv30, id(white),    TextAlign::BOTTOM_RIGHT, "%.0f", pressure);

        // PREPARE VARIABLES
        auto title = "";
        auto unit  = "";
        int  count = 0;
        const char    *names[3];
        float          values[3];
        esphome::Color colors[3];

        // PREPARE PARTICLES
        cy = 30;

        if (!isnan(pm1)) {
          count     = 0;
          title     = "Particles";
          unit      = "µg/m³";
          names[0]  = "PM1";
          names[1]  = "PM2.5";
          names[2]  = "PM10";
          values[0] = pm1;
          values[1] = pm25;
          values[2] = pm10;
          colors[0] = pm1_c;
          colors[1] = pm25_c;
          colors[2] = pm10_c;

          // START REUSABLE
          it.line(0, cy, w, cy, id(white));

          it.print(    2, cy + 22, fh36, id(light_grey), TextAlign::CENTER_LEFT,  title);
          it.print(w - 2, cy + 31, fl14, id(grey),       TextAlign::CENTER_RIGHT, unit );

          ix = 0;
          for (int i = 0; i < 3; i++) {
            if(isnan(values[i])) continue;
            it.printf(w / 6 * (1 + ix * 2), cy + 58, fl14, id(grey),  TextAlign::BOTTOM_CENTER, "%s",   names[i] );
            it.printf(w / 6 * (1 + ix * 2), cy + 50, fv30, colors[i], TextAlign::TOP_CENTER,    "%.0f", values[i]);
            ix++;
          }
          // END REUSABLE
          
          cy += 88;
        }

        // END PARTICLES

        // PREPARE CO2

        if (!isnan(co2) or !isnan(e_co2) or !isnan(s_co2)) {
          count = 0;
          title = "CO2";
          unit = "ppm";
          names[0] = "SCD40";
          names[1] = "ENS160 est.";
          names[2] = "SGP30 est.";
          values[0] = co2;
          values[1] = e_co2;
          values[2] = s_co2;
          colors[0] = co2_c;
          colors[1] = e_co2_c;
          colors[2] = s_co2_c;

          // START REUSABLE
          it.line(0,cy,w,cy,id(white));
          it.print(  2, cy + 22, fh36, id(light_grey), TextAlign::CENTER_LEFT,  title);
          it.print(w-2, cy + 31, fl14, id(grey),       TextAlign::CENTER_RIGHT, unit );
          ix = 0;
          for (int i = 0; i < 3; i++) {
            if(isnan(values[i])) continue;
            it.printf(w / 6 * (1 + ix * 2), cy + 58, fl14, id(grey),  TextAlign::BOTTOM_CENTER, "%s", names[i] );
            it.printf(w / 6 * (1 + ix * 2), cy + 50, fv30, colors[i], TextAlign::TOP_CENTER, "%.0f",  values[i]);
            ix++;
          }
          // END REUSABLE

          cy += 88;
        }

        // END CO2

        // PREPARE VOC

        bool draw_general_voc = (!isnan(ch2o) or !isnan(e_voc) or !isnan(s_voc));
        bool draw_sgp4x = (!isnan(aqi_voc) or !isnan(aqi_nox));
        if (draw_general_voc or draw_sgp4x) {
          count = 0;
          title = "VOC";
          unit = "ppb";
          names[0] = "SGP30";
          names[1] = "ENS160";
          names[2] = "ZE08-CH2O";
          values[0] = s_voc;
          values[1] = e_voc;
          values[2] = ch2o;
          colors[0] = s_voc_c;
          colors[1] = e_voc_c;
          colors[2] = ch2o_c;

          // START REUSABLE | UNIT CONDITION ADDED
          it.line(0, cy, w, cy, id(white));
          it.print(2, cy + 22, fh36, id(light_grey), TextAlign::CENTER_LEFT, title);
          if (draw_general_voc) {
            it.print(w - 2, cy + 31, fl14, id(grey), TextAlign::CENTER_RIGHT, unit);
          }
          ix = 0;
          for (int i = 0; i < 3; i++) {
            if(isnan(values[i])) continue;
            it.printf(w / 6 * (1 + ix * 2), cy + 58, fl14, id(grey),  TextAlign::BOTTOM_CENTER, "%s",   names[i] );
            it.printf(w / 6 * (1 + ix * 2), cy + 50, fv30, colors[i], TextAlign::TOP_CENTER,    "%.0f", values[i]);
            ix++;
          }
          // END REUSABLE

          if (draw_general_voc) {
            cy += 88;
          } else {
            cy += 46;
          }
        }

        // START SGP4x
        cy+=2;
        auto sgp4x = "SGP41";
        if (isnan(aqi_nox)) sgp4x = "SGP40";
        if(!isnan(aqi_voc)) {
          col = id(white);
          it.printf(  2, cy, fl14, id(grey), TextAlign::CENTER_LEFT,  "%s VOC Index", sgp4x  );
          it.printf(180, cy, fl14, id(grey), TextAlign::CENTER_LEFT,  "(1 ... 500)"          );
          it.printf(180, cy, fl14, col,      TextAlign::CENTER_RIGHT, "%.0f ",        aqi_voc);
          cy+=15;
        }

        if(!isnan(aqi_nox)) {
          col = id(white);
          it.printf(  2, cy, fl14, id(grey), TextAlign::CENTER_LEFT,  "%s NOx Index", sgp4x  );
          it.printf(180, cy, fl14, id(grey), TextAlign::CENTER_LEFT,  "(1 ... 500)"          );
          it.printf(180, cy, fl14, col,      TextAlign::CENTER_RIGHT, "%.0f ",        aqi_nox);
        }

        // END VOC & SGP4x
      }

      // --- MANUAL SGP30 BASELINE STATUS MESSAGE (MOVED TO END) ---
      if (id(baseline_status) != 0 && id(page_number) == 0) {
          auto msg_color = id(baseline_status) == 1 ? id(green) : id(red);
          const char* msg_text = id(baseline_status) == 1 ? "Baseline saved" : "Baseline NOT saved";

          // Determine bounding box for the text
          int x0, y0, width, height;
          it.get_text_bounds(
              w/2,              // x start (centered horizontally)
              h-50,             // y start (vertical reference)
              msg_text,         // the text
              fl18,             // font
              TextAlign::CENTER,// alignment
              &x0, &y0, &width, &height
          );

          // Add padding
          int pad_x = 4;
          int pad_y = 2;
          x0 -= pad_x;
          y0 -= pad_y;
          width += 2*pad_x;
          height += 2*pad_y;

          // Draw black rectangle behind text
          it.filled_rectangle(x0, y0, x0 + width, y0 + height, id(black));

          // Draw the text on top
          it.print(w/2, h-50, fl18, msg_color, TextAlign::CENTER, msg_text);
      }

      // --- WIFI STATUS MESSAGE (MOVED TO VERY END) ---
      if (id(wifi_status) != 0 && id(page_number) == 0) {
          auto msg_color = id(wifi_status) == 1 ? id(green) : id(red);
          const char* msg_text = id(wifi_status) == 1 ? "WiFi enabled" : "WiFi disabled";

          // Determine bounding box for the text
          int x0, y0, width, height;
          it.get_text_bounds(
              w/2,              // x start (centered horizontally)
              h-80,             // y start (above baseline message)
              msg_text,         // the text
              fl18,             // font
              TextAlign::CENTER,// alignment
              &x0, &y0, &width, &height
          );

          // Add padding
          int pad_x = 4;
          int pad_y = 2;
          x0 -= pad_x;
          y0 -= pad_y;
          width += 2*pad_x;
          height += 2*pad_y;

          // Draw black rectangle behind text
          it.filled_rectangle(x0, y0, x0 + width, y0 + height, id(black));

          // Draw the text on top
          it.print(w/2, h-80, fl18, msg_color, TextAlign::CENTER, msg_text);
      }

    dimensions:
      height: 320
      width: 240